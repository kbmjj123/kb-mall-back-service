# mongodb-backend-nodejs

## å‰è¨€
> ä½œä¸ºå­¦ä¹ mongodbåŽå°æœåŠ¡ç¼–ç¨‹çš„demoé¡¹ç›®ï¼Œä»Ž0åˆ°1æ­å»ºç›¸åº”çš„ä»£ç ç›®å½•æ¡†æž¶ã€‚
> å¹¶ä»¥æ­¤æ¥æå‡å…³äºŽ`nodejs`å­¦ä¹ çš„ç†Ÿæ‚‰ç¨‹åº¦

## ç›®å½•ç»“æž„è¯´æ˜Ž
```
mongodb-backend-nodejs
â”œâ”€â”€ .env
â”œâ”€â”€ .eslintignore
â”œâ”€â”€ .eslintrc.json
â”œâ”€â”€ .gitignore
â”œâ”€â”€ .nvmrc
â”œâ”€â”€ .prettierignore
â”œâ”€â”€ .prettierrc
â”œâ”€â”€ assets æœ¬åœ°è¯´æ˜Žæ–‡æ¡£æ‰€éœ€å›¾ç‰‡èµ„æº
â”œâ”€â”€ commitlint.config.cjs
â”œâ”€â”€ config
â”‚  â”œâ”€â”€ db-connection.ts ç»Ÿä¸€çš„æ•°æ®åº“è¿žæŽ¥å™¨
â”‚  â”œâ”€â”€ token-generator.ts ç»Ÿä¸€çš„tokenç”Ÿæˆå™¨ï¼ŒåŒ…æ‹¬è®¿é—®tokenä»¥åŠåˆ·æ–°token
â”‚  â””â”€â”€ uploader-generator.ts ç»Ÿä¸€çš„æ–‡ä»¶ä¸Šä¼ é…ç½®ç”Ÿæˆå™¨ï¼Œç”¨äºŽç»Ÿä¸€é…ç½®æ–‡ä»¶ä¸Šä¼ 
â”œâ”€â”€ control  ä¸šåŠ¡é€»è¾‘çš„æŽ§åˆ¶å™¨
â”‚  â”œâ”€â”€ brand-controller.ts	å“ç‰ŒæŽ§åˆ¶å™¨
â”‚  â”œâ”€â”€ cate-controller.ts	åˆ†ç±»æŽ§åˆ¶å™¨
â”‚  â”œâ”€â”€ file-controller.ts	æ–‡ä»¶èµ„æºæŽ§åˆ¶å™¨
â”‚  â”œâ”€â”€ order-controller.ts	è®¢å•æŽ§åˆ¶å™¨
â”‚  â”œâ”€â”€ product-controller.ts	äº§å“æŽ§åˆ¶å™¨
â”‚  â””â”€â”€ user-controller.ts	ç”¨æˆ·æŽ§åˆ¶å™¨
â”œâ”€â”€ doc	 é¡¹ç›®çš„è¯´æ˜Žæ–‡æ¡£å­ç›®å½•
â”‚  â””â”€â”€ å‡çº§è‡³ts.md
â”œâ”€â”€ index.ts	åº”ç”¨ç¨‹åºå…¥å£æ–‡ä»¶
â”œâ”€â”€ lint-staged.config.cjs	å·®åˆ†æäº¤ä»£ç çš„è‡ªåŠ¨æ£€æŸ¥æ‰§è¡Œé…ç½®æ–‡ä»¶
â”œâ”€â”€ middleware	é¡¹ç›®ä¸­ä¸­é—´ä»¶ç›®å½•
â”‚  â”œâ”€â”€ auth-middleware.ts	æŽˆæƒè®¤è¯ä¸­é—´ä»¶ï¼Œä½œä¸ºéœ€è¦æŽˆæƒç™»å½•æˆ–è€…éœ€è¦é«˜çº§æƒé™çš„åˆ¤æ–­æ‹¦æˆªå™¨
â”‚  â”œâ”€â”€ common-result-validate-middleware.ts	ç»Ÿä¸€çš„è¯·æ±‚å‚æ•°æ ¡éªŒç»“æžœä¸­é—´ï¼Œç”¨ä»¥å‘ŠçŸ¥å®¢æˆ·ç«¯å…³äºŽå‚æ•°çš„ç»“æžœå¦‚ä½•è¿›è¡Œå›žå¤æç¤ºçš„æ‹¦æˆªå™¨
â”‚  â”œâ”€â”€ not-found-middleware.ts	ç»Ÿä¸€çš„æ‹¦æˆªæœªæ‰¾åˆ°çš„ä¸­é—´ä»¶
â”‚  â”œâ”€â”€ response-wrapper-middleware.ts	ç»Ÿä¸€çš„å“åº”åŒ…è£…å™¨ä¸­é—´ä»¶ï¼Œç”¨ä»¥è¿”å›žç»Ÿä¸€çš„æ ¼å¼ç»™å®¢æˆ·ç«¯
â”‚  â””â”€â”€ service-error-middleware.ts	ç»Ÿä¸€çš„å¼‚å¸¸å“åº”å¤„ç†ä¸­é—´ä»¶
â”œâ”€â”€ model	é¡¹ç›®ä¸­çš„modelæ•°æ®åº“è®¿é—®çš„æ˜ å°„å™¨
â”‚  â”œâ”€â”€ address-model.ts
â”‚  â”œâ”€â”€ brand-model.ts
â”‚  â”œâ”€â”€ cate-model.ts
â”‚  â”œâ”€â”€ evaluate-model.ts
â”‚  â”œâ”€â”€ order-model.ts
â”‚  â”œâ”€â”€ product-model.ts
â”‚  â”œâ”€â”€ shopping-car-model.ts
â”‚  â””â”€â”€ user-model.ts
â”œâ”€â”€ package.json
â”œâ”€â”€ README.md é¡¹ç›®ä»‹ç»æ–‡æ¡£
â”œâ”€â”€ resources 
â”œâ”€â”€ router	å°†ç³»ç»Ÿçš„æŽ¥å£è¿›è¡Œæ¨¡å—åŒ–ç®¡ç†ï¼Œä¹Ÿå°±æ˜¯æ¨¡å—åŒ–æŽ¥å£å®šä¹‰çš„ä½ç½®
â”‚  â”œâ”€â”€ common-router.ts
â”‚  â”œâ”€â”€ file-upload-router.ts
â”‚  â”œâ”€â”€ index.ts
â”‚  â”œâ”€â”€ order-router.ts
â”‚  â”œâ”€â”€ product-router.ts
â”‚  â””â”€â”€ user-router.ts
â”œâ”€â”€ tsconfig.json
â”œâ”€â”€ types
â”‚  â”œâ”€â”€ env.d.ts
â”‚  â”œâ”€â”€ express
â”‚  â”‚  â””â”€â”€ index.d.ts
â”‚  â””â”€â”€ jwt.d.ts
â””â”€â”€ uploads æ‰€æœ‰å®¢æˆ·ç«¯ä¸Šä¼ è¿‡æ¥çš„æœ€ç»ˆå­˜å‚¨ä½ç½®
```

## å¯åŠ¨å‘½ä»¤
> ä¸€èˆ¬åœ°ï¼Œæˆ‘ä»¬é‡‡ç”¨`node index.js`çš„æ–¹å¼æ¥å¯åŠ¨ä¸€ä¸ªç¨‹åºï¼ŒðŸ˜£ ä½†æ˜¯ï¼Œåœ¨å®žé™…çš„ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šç»å¸¸æ›´æ”¹ç›¸å…³çš„ç¨‹åºæ–‡ä»¶ï¼Œæ¯æ¬¡éƒ½éœ€è¦å…³æŽ‰æ—§æœåŠ¡ï¼Œå¹¶é‡æ–°å¼€å¯æ–°çš„æœåŠ¡ï¼Œå› æ­¤ï¼Œå¯ä»¥å€ŸåŠ©äºŽæ–°çš„ä¸€ä¸ªåº“ï¼š`nodemon`ï¼Œå…³äºŽè¿™ä¸ªåº“çš„è¯´æ˜Žï¼Œè¯¦æƒ…è§ [å®˜ç½‘](https://www.npmjs.com/package/nodemon)ï¼Œé€šè¿‡ä½¿ç”¨è¿™ä¸ª`nodeman`å‘½ä»¤ï¼Œå¯ä»¥å®žçŽ°å…é‡å¯æœåŠ¡å®žçŽ°ä»£ç çš„æ›´æ–°ï¼
```shell
  nodeman index.js
```
è¿™è¾¹åŒæ—¶å°†æ‰§è¡ŒæœåŠ¡çš„å‘½ä»¤ï¼Œç»´æŠ¤åˆ°`package.json`ä¸­çš„`script`èŠ‚ç‚¹ä¸­ï¼Œå¹¶æ‰§è¡Œè¯¦æƒ…çš„å‘½ä»¤ï¼Œæ•ˆæžœå¦‚ä¸‹ï¼š
![nodemonæ‰§è¡Œç»“æžœ](./assets/è®¿é—®ä¸å­˜åœ¨çš„é“¾æŽ¥å¼‚å¸¸ç»“æžœ.png)

## ä¸‰æ–¹åº“ä¾èµ–è¯´æ˜Ž
> ðŸ‘‡ æ•´ç†äº†å…³äºŽæœ¬é¡¹ç›®ä¸­åœ¨codingè¿‡ç¨‹ä¸­æ‰€ä½¿ç”¨çš„ä¸‰æ–¹ä¾èµ–åº“è¯´æ˜Žæ¸…å•ï¼š

| ä¾èµ–åç§° | æè¿° | ç›¸å…³åœ°å€ |
|---|---|---|
| express | nodesjè½»é‡çº§æœåŠ¡åº“ | [å®˜æ–¹åœ°å€](https://expressjs.com/) |
| mongoose | mongodbçš„ogm | [å®˜æ–¹åœ°å€](https://mongoosejs.com/) |
| bcrypt | åŠ å¯†åº“ï¼Œç”¨äºŽåŠ å¯†ä»¥åŠå¯†ç æ ¡éªŒç”¨é€” | [åº“åœ°å€](https://www.npmjs.com/package/bcrypt) |
| jsonwebtoken | ç”¨äºŽtokençš„æ ¡éªŒå’Œå¤„ç†å·¥ä½œ | [åº“åœ°å€](https://www.npmjs.com/package/jsonwebtoken) |
| dotenv | ç”¨äºŽåŠ è½½çŽ¯å¢ƒå˜é‡çš„ä¸‰æ–¹åº“ï¼Œä¾¿äºŽå°†ç›¸å…³çš„é…ç½®ä¿¡æ¯é€šè¿‡æ–‡ä»¶é…ç½®åŒ–çš„æ–¹å¼æ¥ç»´æŠ¤ï¼Œä¸”åœ¨é¡¹ç›®ä¸­å¯é€šè¿‡`process.env.*`çš„æ–¹å¼æ¥è®¿é—®åˆ° | [åº“åœ°å€](https://www.dotenv.org/) |
| body-parser | ç”¨äºŽå¯¹è¯·æ±‚ä½“çš„è§£æžï¼Œä½¿å¾—åŽç»­çš„ä¸­é—´ä»¶å¯ä»¥ä»Ž`res.body`ä¸­èŽ·å–è¯·æ±‚å‚æ•°ä¿¡æ¯ | [åº“åœ°å€](https://www.npmjs.com/package/body-parser) |
|  |  |  |

## expresså®˜æ–¹çš„ä¸­é—´ä»¶ä»¥åŠè‡ªå®šä¹‰ä¸­é—´ä»¶
> ä½¿ç”¨`express`æ¥å¼€å‘çš„è¯ï¼Œä¸€èˆ¬ä¼šé…å¥—ä½¿ç”¨å®˜æ–¹æ‰€æä¾›çš„ä¸­é—´ä»¶ï¼Œ ðŸ‘‡ æ˜¯å¯¹åº”çš„å®˜æ–¹ä¸­é—´ä»¶è¯´æ˜Žæ¸…å•ï¼š

1. `express-async-handler`: ç®€å•çš„ä¸­é—´ä»¶ï¼Œç”¨äºŽå¤„ç†`express`è·¯ç”±å†…çš„å¼‚å¸¸ï¼Œå¹¶å°†å®ƒä»¬ä¼ é€’ç»™EXPRESSé”™è¯¯å¤„ç†ç¨‹åº
   ðŸ¤” ç”¨äºŽè‡ªåŠ¨å°†ä¸­é—´ä¸­äº§ç”Ÿçš„å¼‚å¸¸ï¼Œè‡ªåŠ¨`next`åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼ŒçœåŽ»äº†åœ¨æ¯ä¸€ä¸ªä¸­é—´ä»¶ä¸­æ˜¾ç¤ºåœ°è°ƒç”¨`next()`æ–¹æ³•æ¥å°†ä»»åŠ¡è½¬ç§»åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œè¯¦è§[å®˜ç½‘å¯¹æ¯”æè¿°](https://www.npmjs.com/package/express-async-handler#usage)
2. `morgan`: è¯·æ±‚æ—¥å¿—è¾“å‡ºä¸­é—´ä»¶ï¼Œç”¨äºŽå°†å®¢æˆ·ç«¯è¯·æ±‚çš„è·¯å¾„ã€æ–¹å¼ã€å“åº”æ—¶é•¿ç­‰ä¿¡æ¯ç»™è¾“å‡ºæ¥ï¼Œä¾¿äºŽè°ƒè¯•ï¼›
3. `multer`: å¤„ç†æ–‡ä»¶ä¸Šä¼ çš„ä¸­é—´ä»¶ï¼ŒèŽ·å–å®¢æˆ·ç«¯æäº¤çš„æ–‡ä»¶èµ„æºï¼Œå¹¶è¿›è¡Œè¿œç¨‹æœåŠ¡å™¨å­˜å‚¨ï¼Œç„¶åŽè¿”å›žè¿œç¨‹è·¯å¾„ç»™å›žå®¢æˆ·ç«¯ï¼Œè¯¦è§[å®˜ç½‘æè¿°](https://github.com/expressjs/multer)ï¼›
4. `serve-static`: åœ¨çº¿é™æ€èµ„æºçš„ç›´æŽ¥è®¿é—®ï¼Œé€šè¿‡é…ç½®çš„æ–¹å¼ï¼Œå¯¹ä¸Šä¼ ä¸Šæ¥çš„æ–‡ä»¶èµ„æºæä¾›åœ¨çº¿è®¿é—®çš„ç›®çš„ï¼Œ[è¯¦è§å®˜ç½‘](https://github.com/expressjs/serve-static#readme)
5. `cors`: `Cross-Origin Resource Sharing`ï¼Œä¸€ç§å®‰å…¨æœºåˆ¶ï¼Œå®ƒå…è®¸Webé¡µé¢è·¨åŸŸè¿›è¡Œèµ„æºå…±äº«ï¼Œé»˜è®¤æƒ…å†µä¸‹ï¼Œæ¥è‡ªä¸åŒæºçš„Webé¡µé¢ä¸èƒ½å¤Ÿå…±äº«èµ„æºï¼Œæºæ˜¯ç”±åè®®ã€åŸŸåå’Œç«¯å£ä¸‰è€…ç»„åˆå®šä¹‰çš„ï¼Œåªæœ‰å½“æ‰€æœ‰ä¸‰è€…éƒ½åŒ¹é…æ—¶ï¼Œä¸¤ä¸ªURLæ‰å±žäºŽåŒä¸€ä¸ªæºï¼Œ[è¯¦è§å®˜ç½‘](https://github.com/expressjs/cors#readme);
6. `express-validator`: æ•°æ®æ ¡éªŒä¸­é—´ä»¶ï¼Œç”¨äºŽå¤„ç†å®¢æˆ·ç«¯æ‰€ä¼ é€’è¿‡æ¥çš„æ•°æ®æ ¡éªŒåŠ¨ä½œï¼ŒåŸºäºŽè·¯ç”±ä¸­é—´ä»¶ï¼Œé€šå¸¸ç”¨äºŽæ ¡éªŒè¿›å…¥åº”ç”¨ç¨‹åºçš„è¯·æ±‚æ•°æ®ï¼Œå¹¶åœ¨æ•°æ®è¿›å…¥æŽ§åˆ¶å™¨é€»è¾‘ä¹‹å‰æ‹¦æˆªæ— æ•ˆè¯·æ±‚ã€‚è¿™æœ‰åŠ©äºŽé˜²æ­¢ä¸åˆç†çš„è¾“å…¥æ•°æ®å¯¼è‡´çš„æ½œåœ¨é”™è¯¯ï¼Œå‡è½»åŽç«¯æŽ§åˆ¶å™¨çš„è´Ÿæ‹…ï¼Œ[è¯¦è§å®˜ç½‘](https://express-validator.github.io/docs/);

### æœ¬åœ°è‡ªå®šä¹‰ä¸­é—´ä»¶
> å› å®žé™…ä¸šåŠ¡å¼€å‘éœ€è¦ï¼Œé’ˆå¯¹ä¸šåŠ¡è¿›è¡Œç›¸åº”çš„æœ¬åœ°åŒ–ä¸­é—´ä»¶å¼€å‘ï¼Œä»¥ä¾¿äºŽæ»¡è¶³é¡¹ç›®çš„å˜åŠ¨å‘å±•è¯‰æ±‚ï¼Œ ðŸ‘‡ æ˜¯å¯¹åº”çš„è‡ªå®šä¹‰æœ¬åœ°ä¸­é—´ä»¶è¯´æ˜Žæ¸…å•ï¼š

| ä¸­é—´ä»¶åç§° | æè¿° |
|---|:---|
| not-found-middleware | æ‰¾ä¸åˆ°æœåŠ¡ï¼Œä¹Ÿå°±æ˜¯404 |
| service-error-middleware | ç»Ÿä¸€çš„å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶ |
| response-wrapper-middleware | ç»Ÿä¸€çš„ç½‘ç»œå“åº”è‡ªå®šä¹‰æ ¼å¼åŒ–ä¸­é—´ä»¶ï¼Œæä¾›è‡ªå®šä¹‰çš„`success`ä»¥åŠ`failed`æ–¹æ³•æ¥å‘ä¸šåŠ¡æä¾›ä¸€é”®è°ƒç”¨çš„æ–¹æ³• |
|  |  |
|  |  |

### .envé…ç½®æ–‡ä»¶å˜é‡å£°æ˜Ž
1. MONGODB_URL: mongodbæ•°æ®åº“è¿žæŽ¥åœ°å€ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯å®˜æ–¹æ‰€æä¾›çš„å…è´¹å…±äº«çš„æ•°æ®åº“ï¼›
2. SERVICE_PORT: åŽå°æœåŠ¡å¯åŠ¨ç»‘å®šçš„ç«¯å£å·ï¼›

## é¡¹ç›®è¿‡ç¨‹è®°å½•
> æ­¤ç›®å½•ä»¥åŠåŽç»­çš„å†…å®¹ï¼Œå°†è®°å½•æ•´ä¸ªé¡¹ç›®è¿‡ç¨‹ä¸­çš„ç¬”è®°ï¼Œä¾¿äºŽåŽç»­è·Ÿè¸ªä¸ŽåæŸ¥é—®é¢˜ï¼ï¼

### æ ¹æ®æ ‡å‡†çš„MVCç†å¿µï¼Œåˆ›å»ºå¥½å¯¹åº”çš„æ–‡ä»¶èµ„æºç›®å½•ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼š
  ![æ–‡ä»¶èµ„æºç›®å½•](./assets/ç›®å½•ç»“æž„.png)

### åˆ›å»ºå®Œæˆ404ä»¥åŠå…¬å…±çš„å¼‚å¸¸å¤„ç†ä¸­é—´ä»¶(å…·ä½“è§ä¸¤ä¸­é—´ä»¶çš„ä»£ç å†…å®¹)ï¼Œå¹¶åšå¯¹åº”çš„æµ‹è¯•éªŒè¯ï¼š
```javascript
app.get('/login', (req, res, next) => {
  const error = new Error('è‡ªå®šä¹‰å¼‚å¸¸ä¿¡æ¯')
  throw error;
})
```
![404å¼‚å¸¸](./assets/è®¿é—®ä¸å­˜åœ¨çš„é“¾æŽ¥å¼‚å¸¸ç»“æžœ.png)

### æ ¹æ®ä¸šåŠ¡å®žé™…åœºæ™¯ï¼Œå°†é¡¹ç›®æ‹†åˆ†ä¸ºä¸åŒçš„æ¨¡å—ï¼ŒåŒæ—¶å¯¹åº”äºŽä¸åŒçš„è·¯ç”±æ¨¡å—ï¼ŒåŒæ—¶å€Ÿé‰´äºŽå‰ç«¯æ¨¡å—åŒ–å¼€å‘çš„æ–¹å¼ï¼Œå°†æ‰€æœ‰çš„è·¯ç”±æ¨¡å—é‡‡ç”¨å¯¹å¤–ä»…æš´éœ²ä¸€ä¸ªå…¥å£çš„æ–¹å¼ 
```javascript
  const userRouter = require('./userRouter')
  // è¿™é‡Œé‡‡ç”¨å¯¹å¤–æš´éœ²ä¸€ä¸ªæŽ¥æ”¶appåº”ç”¨ç¨‹åºå…¥å£çš„æ–¹å¼ï¼Œæ¥å¯¹å¤–éšè—æ³¨å†Œçš„æ–¹å¼
  module.exports = app => {
    app.use('/user', userRouter);
  }
```

### åœ¨ä»¥å¾€çš„é¡¹ç›®å‰åŽç«¯æŽ¥å£å¯¹æŽ¥ä¸­ï¼Œä¸€èˆ¬éœ€è¦ä¸¥æ ¼è§„å®šé‡‡ç”¨å•†å®šå¥½çš„å›ºå®šæ•°æ®ç»“æž„æ¥äº¤äº’ï¼Œä»¥å…å› ä¸ºåŽç»­ä¸šåŠ¡é€»è¾‘çš„è¿­ä»£å¯¼è‡´é¡¹ç›®éš¾ä»¥ç»´æŠ¤ï¼Œå› æ­¤è¿™é‡Œé‡‡ç”¨ ðŸ‘‡ ä»¥ä¸‹è¿™ç§æ•°æ®ç»“æž„
```json
  {
    "status": 0,
    "message": "business logic operate result",
    "data": {}
  }
```
ðŸ¤”ï¸ å…³äºŽðŸ‘†å‡ ä¸ªå­—æ®µçš„æè¿°å¦‚ä¸‹ï¼š
1. status: ä»£è¡¨æŽ¥å£å¤„ç†ç»“æžœï¼Œä¸€èˆ¬0ä»£è¡¨å¤„ç†æ­£å¸¸ï¼Œå³å°†è¿”å›žæ­£å¸¸å¯¹åº”çš„ç»“æžœç›®æ ‡æ•°æ®ï¼Œéž0åˆ™æ ¹æ®å®žé™…ä¸šåŠ¡åœºæ™¯è¿›è¡Œæžšä¸¾æ¸…å•çš„ç½—åˆ—ï¼Œæœ€å¥½æ˜¯å°†è¿™ä¸ªæžšä¸¾å€¼æ¸…å•ðŸ§¾æ•´ç†åˆ°é¡¹ç›®ä¸­ï¼Œä»¥ä¾¿äºŽé¡¹ç›®å›¢é˜ŸåŒäº‹ååŒå·¥ä½œï¼›
2. message: ä»£è¡¨æŽ¥å£å¤„ç†ç»“æžœè¯´æ˜Žï¼Œæœ‰æ—¶å¯ä½œä¸ºæŽ¥å£ç»“æžœè¯´æ˜Žæç¤ºä¿¡æ¯æ¥å±•ç¤ºåˆ°å‰ç«¯ç•Œé¢ä¸Šï¼›
3. data: è¿™é‡Œæ˜¯ç»Ÿä¸€çš„ç»“æžœæ•°æ®ï¼Œæ ¹æ®å®žé™…ä¸šåŠ¡åœºæ™¯éœ€è¦ï¼Œä¸åŒçš„æŽ¥å£é€»è¾‘å¯¹åº”ä¸åŒçš„dataå®žä½“å¯¹è±¡ï¼Œè¿™é‡Œå…³äºŽdataä¸»è¦æœ‰ ðŸ‘‡ 4ç§æ•°æ®ç±»åž‹ï¼š
   - booleanç±»åž‹ï¼Œä»£è¡¨åŠ¨è¯ç±»æŽ¥å£ï¼Œä¸€èˆ¬trueä»£è¡¨æ‰§è¡ŒæˆåŠŸï¼Œfalseä»£è¡¨æ‰§è¡Œå¤±è´¥ï¼›
   - string/numberç±»åž‹ï¼ŒåŒbooleanç±»ä¼¼ï¼Œç»“æžœæ˜¯å¯¹åº”çš„string/number;
   - objectç±»åž‹ï¼Œä¸€èˆ¬è¡¨ç¤ºæŸ¥è¯¢ç»“æžœï¼Œæ¯”å¦‚æŸ¥è¯¢è¿”å›žæŸä¸€ç”¨æˆ·ä¿¡æ¯å¯¹è±¡;
   - object(list+page+total)ç±»åž‹ï¼Œåˆ—è¡¨æŸ¥è¯¢ç±»ï¼Œä¸€èˆ¬æŸ¥è¯¢åˆ—è¡¨é¡¹ç›®ï¼Œlistå­˜å‚¨åˆ—è¡¨æ•°æ®ï¼Œpageä»£è¡¨å½“å‰é¡µç ï¼Œtotalä»£è¡¨å½“ä¸‹æŸ¥è¯¢ç­›é€‰æ¡ä»¶çš„æ€»æ•°;

ðŸ¤”è€Œè¿™ä¸ª`express`æ¡†æž¶ä¸­ï¼Œåˆ™æ˜¯é€šè¿‡å¯¹`res.json()`çš„æ–¹å¼ï¼Œå°†ç»“æžœè¿”å›žç»™å®¢æˆ·ç«¯çš„ï¼Œå‡å¦‚ç›´æŽ¥é’ˆå¯¹è¿™ä¸ªæ–¹æ³•è¿›è¡Œé‡å†™çš„è¯ï¼Œ**å°†æœ‰å¯èƒ½å› ä¸ºé‡å†™äº†è¯¥æ–¹æ³•è€Œå¯¼è‡´çš„å…¶ä»–ç¤¾åŒº/å®˜æ–¹çš„ä¸­é—´ä»¶æ— æ³•æ­£å¸¸ä½¿ç”¨äº†ï¼ï¼**å› æ­¤ï¼Œå¯ä»¥è€ƒè™‘è‡ªå®šä¹‰å“åº”æ–¹æ³•ï¼Œä»Žè€Œåœ¨ä¸šåŠ¡åœºæ™¯ä¸­æ ¹æ®ç»“æžœæƒ…å†µç›´æŽ¥è°ƒç”¨å¯¹åº”çš„æ–¹æ³•ï½ž

### åˆ›å»ºæ•°æ®åº“è¿žæŽ¥
> å€ŸåŠ©äºŽ`mongoose`ä¸‰æ–¹åº“ï¼Œé€šè¿‡MONGODB_URLæ¥è¿žæŽ¥åˆ°è¿œç¨‹æ•°æ®åº“ä¸­ï¼
> å°†dbè¿žæŽ¥ç›¸å…³çš„ç»Ÿä¸€åˆ°ä¸€å¤–éƒ¨æ–¹æ³•`db-connection`ä¸­ï¼
> âœ¨ åŒæ—¶åœ¨è¿žæŽ¥æˆåŠŸåŽï¼Œæ‰“å°ç›¸å…³çš„æ—¥å¿—ä¿¡æ¯ï¼Œåœ¨`mongoose.connection.on()`ç›¸å…³çš„å›žè°ƒæ–¹æ³•ä¸­æ·»åŠ å¯¹åº”çš„æ—¥å¿—ä»£ç ï¼

### èµ„æºä¸Šä¼ ä¸­é—´ä»¶
> :confused: ä¹Ÿè®¸æœ‰äººä¼šè¯´ï¼Œå·²ç»æœ‰è¿™ä¸ª`multer`ä¸­é—´ä»¶å•¦ï¼Œç›´æŽ¥ç”¨å°±å¯ä»¥å•¦ï¼æ˜¯çš„ï¼Œçš„ç¡®å¦‚æ­¤ï¼Œå¯ä»¥ç›´æŽ¥ä½¿ç”¨è¿™ä¸ªä¸­é—´ä»¶æ¥å¤„ç†æ–‡ä»¶ä¸Šä¼ ï¼Œå¹¶å­˜å‚¨åˆ°å¯¹åº”çš„ä½ç½®ï¼Œ :point_right: ä½†æ˜¯åœ¨å®žé™…çš„é¡¹ç›®è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¼šå‘çŽ°ï¼Œéšç€æ—¶é—´çš„æŽ¨ç§»ï¼Œé¡¹ç›®ä¸­çš„èµ„æºä¼šè·Ÿéšç€ä½¿ç”¨è€…çš„ä½¿ç”¨è¶Šæ¥è¶Šå¤šï¼Œéœ€è¦å¯¹èµ„æºè¿›è¡Œä¸€ä¸ªç»Ÿä¸€ç®¡ç†ï¼Œå‡å¦‚å‰ææ²¡æœ‰å¾ˆå¥½çš„æä¾›ä¸€ä¸ªç®¡ç†æœºåˆ¶çš„è¯ï¼Œæ˜¯å½“é¡¹ç›®èµ·æ¥åŽï¼Œæ˜¯å¾ˆéš¾ä¿æŒé¡¹ç›®è¾¹è¿è¡Œï¼Œè¾¹å®žçŽ°æ”¹é€ è¿ç§»å·¥ä½œçš„ã€‚
> å› æ­¤ï¼Œå¾ˆæœ‰å¿…è¦åœ¨å‰æœŸè¿›è¡Œä¸€ä¸ªè®¾è®¡ï¼Œå¹¶èµ‹äºˆå®žæ–½ï¼
> :alien: æˆ‘ä»¬çš„ç›®çš„ï¼Œå°±æ˜¯æä¾› :one: ä¸ªå•æ–‡ä»¶ä¸Šä¼ ä»¥åŠ :one: ä¸ªå¤šæ–‡ä»¶ä¸Šä¼ çš„æŽ¥å£APIï¼Œ :point_right: å€ŸåŠ©äºŽ`multer`ä¸­é—´ä»¶ï¼Œå¹¶ç»“åˆ`fs`ã€`ä¸´æ—¶æ–‡ä»¶å­˜å‚¨`çš„æœºåˆ¶ï¼Œæ¥å®žçŽ°æ–‡ä»¶èµ„æºç®¡ç†å™¨ï¼
> 
> :point_down: æ˜¯å¯¹åº”çš„ä¸€ä¸ªæµç¨‹å›¾ï¼š

![æ–‡ä»¶ä¸Šä¼ æœåŠ¡æµç¨‹å›¾](./assets/æ–‡ä»¶ä¸Šä¼ æœåŠ¡æµç¨‹å›¾.png)

:star2: é€šè¿‡ç›´æŽ¥å°†`multer`çš„ä¸Šä¼ ç›®å½•å½“ä½œä¸€ä¸´æ—¶ä¸­é—´ç›®å½•ï¼Œå¯¹æ¯”æœ¬åœ°ç£ç›˜æ–‡ä»¶ä¸Žåˆšä¸Šä¼ çš„æ–‡ä»¶çš„å†…å®¹çš„hashå€¼ï¼Œä»Žè€Œåˆ¤æ–­æ˜¯å¦æ˜¯å®Œå…¨ä¸€æ ·çš„æ–‡ä»¶ï¼Œå‡å°‘é‡å¤æ–‡ä»¶ä¸Šä¼ çš„å¯èƒ½æ€§ã€‚
![æ–‡ä»¶å­˜åœ¨](./assets/æ–‡ä»¶å­˜åœ¨.png)
![æ–‡ä»¶æ›¿æ¢](./assets/æ–‡ä»¶æ›¿æ¢.png)

:dizzy_face: è¿˜æœ‰å…¶ä»–çš„åœºæ™¯ï¼Œæ˜¯ç›®å‰è¿˜æ²¡æœ‰æä¾›çš„ï¼š
1. æ¯”å¦‚ä¸åŒçš„äººä¸Šä¼ çš„åŒä¸€ä¸ªæ–‡ä»¶åçš„æ–‡ä»¶ï¼Œæœ‰å¯èƒ½å› ä¸ºæ²¡æœ‰ç›®å½•æŽ§åˆ¶ï¼Œå¯¼è‡´ä¸¤è€…çš„æ–‡ä»¶æ•°æ®å¯èƒ½ä¼šå‘ç”Ÿé”™ä¹±ï¼›
2. è¿™é‡Œæ˜¯å…ˆä¸Šä¼ æ–‡ä»¶å†å¯¹æ¯”çš„æµç¨‹ï¼Œå®žé™…ä¸Šï¼Œè¿˜å¯ä»¥æ˜¯åœ¨ä¸Šä¼ æ–‡ä»¶ä¹‹å‰ï¼Œåœ¨å®¢æˆ·ç«¯é‡‡ç”¨ä¸ŽæœåŠ¡ç«¯ä¸€è‡´çš„æ–‡ä»¶hashå€¼èŽ·å–é€»è¾‘ï¼Œé€šè¿‡ä¸Šä¼ æ–‡ä»¶çš„hashå€¼ï¼Œä¸ŽåŽå°å­˜å‚¨(redisã€db)ä¸­æ‰€å­˜å‚¨çš„hashå€¼è¿›è¡Œä¸€ä¸ªå¯¹æ¯”ï¼Œå¦‚æžœå­˜åœ¨ï¼Œåˆ™ç›´æŽ¥è·³è¿‡ï¼Œå½“ç„¶ï¼Œè¿™é‡Œæ„å‘³ç€éœ€è¦å¯¹æ–‡ä»¶çš„hashå€¼è¿›è¡Œå…¶ç”Ÿå‘½å‘¨æœŸçš„ç®¡ç†ï¼Œæ¯”å¦‚ä¸Šä¼ æˆåŠŸåŽï¼Œå­˜å‚¨/æ›´æ–°å¯¹åº”çš„hashå€¼ç­‰ç­‰ï¼›
3. å®žé™…ä¸Šï¼Œæ–‡ä»¶çš„å­˜å‚¨ï¼Œåº”è¯¥æ˜¯æŒ‰ç…§ç±»åž‹ç„¶åŽæŒ‰ç…§å¯¹åº”çš„æ—¥æœŸæ¥è¿›è¡Œå­˜å‚¨å¯èƒ½ä¼šæ¯”è¾ƒå¥½ä¸€ç‚¹ï¼Œè¿™æ ·å­å¯èƒ½èƒ½å¤Ÿæ›´å¥½åœ°ç®¡ç†ç£ç›˜æ–‡ä»¶ï¼›
4. è¿™è¾¹é‡‡ç”¨çš„åœ¨queryä¸­ä¼ é€’ä¸€ä¸ªpathå­—æ®µï¼Œç”¨äºŽæŽ§åˆ¶å°†åœ¨åŽå°å“ªä¸ªæ–‡ä»¶å¤¹ä¸­æ¥å­˜æ”¾å½“å‰ä¸Šä¼ æ–‡ä»¶ï¼Œè¿™é‡Œæœ‰ä¸€ä¸ªæ¼æ´žé—®é¢˜ï¼Œå°±æ˜¯å¦‚æžœè¢«ç–¯ç‹‚æŽ‰ç”¨çš„ï¼Œæœ‰å¯èƒ½åœ¨åŽå°ç–¯ç‹‚åˆ›å»ºä¸åŒçš„æ–‡ä»¶å¤¹ç›®å½•ï¼Œæ’‘çˆ†åŽå°ç£ç›˜ç©ºé—´äº†ï¼Œéœ€è¦åšè¿›ä¸€æ­¥çš„ç›®å½•ä¸Šä¼ æŽ§åˆ¶ï¼

### å¼€å§‹ç¼–å†™ä¸šåŠ¡å¤„ç†ä¸­é—´ä»¶
> åœ¨å¼€å§‹ç¼–å†™å…·ä½“çš„ä¸­é—´ä»¶æ—¶ï¼Œå…ˆå¼•å…¥ä¸€ä¸ªè¯·æ±‚è§£æžä¸­é—´ä»¶ï¼Œå¦åˆ™å°±ä¼šå‡ºçŽ° ðŸ‘‡ è¿™æ ·å­çš„ä¸€ä¸ªç»“æžœï¼š
![æœªä½¿ç”¨body-parserçš„ç»“æžœ](./assets/æœªä½¿ç”¨body-parserçš„ç»“æžœ.png)

âœ¨ æ‰§è¡Œ ðŸ‘‡ çš„å‘½ä»¤å®‰è£…å¯¹åº”çš„ä¾èµ–
```shell
  npm install --save body-parser
```
âœ¨ å°†ä¸­é—´ä»¶é›†æˆåˆ°é¡¹ç›®ä»£ç ä¸­
```javascript
  //? é…ç½®è§£æžè¯·æ±‚ä½“çš„ä¸­é—´ä»¶
  app.use(bodyParser.urlencoded({ extended: false }));
  app.use(bodyParser.json());
  // ....è¿™é‡Œçœç•¥ä¸€ç³»åˆ—ä»£ç ï¼Œç„¶åŽåœ¨å“åº”å¤„ç†ä¸­é—´ä»¶ä¸­å¯è®¿é—®åˆ°req.body
  const newUser = await userModel.create(req.body);
```

#### ç”¨æˆ·æ¨¡å—ä¸­é—´ä»¶
> æ ¹æ®ä¹‹å‰çš„è®¾ç½®ï¼Œæ ¹æ®ä¸šåŠ¡åœºæ™¯ï¼Œæ‹†åˆ†ä¸ºä¸€ä¸ªä¸ªçš„ä¸šåŠ¡ä¸­é—´ä»¶æ¨¡å—ï¼Œç”±å„è‡ªçš„å…¥å£æ–‡ä»¶è¿›è¡Œä¸€ä¸ªç»Ÿä¸€çš„ç»´æŠ¤

##### æ–°å¢žuserControllerä½œä¸ºç”¨æˆ·é€»è¾‘æŽ§åˆ¶å™¨
> åœ¨controlç›®å½•ä¸­æ–°å¢ž`userController.js`ä½œä¸ºä¸šåŠ¡é€»è¾‘æŽ§åˆ¶å™¨ï¼Œä¸»è¦å¼•å…¥ç›¸å…³çš„modelè¿›è¡Œdbçš„å¢žåˆ æŸ¥æ”¹ç­‰æ“ä½œï¼ï¼
> ä¸€èˆ¬æƒ…å†µä¸‹ï¼Œæˆ‘ä»¬æ‰€ä½¿ç”¨çš„å¯†ç éƒ½æ˜¯éœ€è¦å¯†æ–‡æ–¹å¼æ¥å­˜å‚¨çš„ï¼Œè¿™æ„å‘³ç€å®¢æˆ·ç«¯å¿…é¡»æŒ‰ç…§åŒä¸€ä¸ªåŠ å¯†è§„åˆ™ï¼Œæ¥å°†å¯†ç ä¼ é€’ç»™åˆ°åŽå°æœåŠ¡ï¼Œè€Œä¸”
> åŽå°æœåŠ¡éœ€è¦é’ˆå¯¹è¿™ä¸ªå¯†ç å†æ¬¡è¿›è¡Œä¸€æ¬¡åŠ å¯†ï¼Œè€Œä¸”è¿˜åº”è¯¥æä¾›ä¸€ç§æ–¹å¼ç”¨äºŽå¯¹å¯†ç æ­£ç¡®æ€§çš„æ ¡éªŒæœåŠ¡ï¼
> ðŸ‘‰ è¿™é‡Œï¼Œæˆ‘ä»¬é€šè¿‡å€ŸåŠ©äºŽ`bcrypt`åº“ï¼Œæ¥ ðŸˆµï¸ è¶³åˆšåˆšæåŠåˆ°çš„ç›¸å…³ç›®çš„ï¼š
```javascript
  userSchema.pre('save', async function(next){
  //? åœ¨å¯†ç å­˜å‚¨ä¹‹å‰ï¼Œå¯¹å¯†ç è¿›è¡ŒåŠ ç›åŠ å¯†
  this.password = await bcrypt.hash(this.password, Number(process.env.BCRYPT_SALT));
  next()
})
```
âœ¨è¿™é‡Œæˆ‘ä»¬é€šè¿‡å¯¹`save`ä¸­é—´ä»¶æ–¹æ³•è¿›è¡Œæ‹¦æˆªï¼Œå½“è¦ä¿å­˜ç”¨æˆ·ä¿¡æ¯æ—¶ï¼Œè‡ªåŠ¨å¯¹å®¢æˆ·ç«¯ä¼ é€’çš„å¯†ç è¿›è¡ŒåŠ å¯†å­˜å‚¨ï¼ï¼
![æ³¨å†Œè‡ªåŠ¨é’ˆå¯¹å¯†ç è¿›è¡ŒåŠ å¯†æ‹¦æˆªæ“ä½œ](./assets/æ³¨å†Œè‡ªåŠ¨é’ˆå¯¹å¯†ç è¿›è¡ŒåŠ å¯†æ‹¦æˆªæ“ä½œ.png)

ðŸ¤” æ—¢ç„¶å­˜å‚¨æˆåŠŸäº†ï¼Œé‚£ä¹ˆå½“æˆ‘ä»¬ä½¿ç”¨å¯¹åº”çš„è´¦å·ä¸Žå¯†ç ç™»å½•çš„æ—¶å€™ï¼Œå°±å¯ä»¥é€šè¿‡åˆ¤æ–­è´¦å·ä¸Žå¯†ç æ˜¯å¦åˆ†åˆ«ç›¸ç­‰å³å¯åˆ¤æ–­æ˜¯å¦ç™»å½•æˆåŠŸäº†ï¼Œè¿™é‡Œå€ŸåŠ©äºŽ`bcrypt.compare()`æ–¹æ³•æ¥å®žçŽ°å¯¹æ¯”æ ¡éªŒçš„ç›®çš„ï¼š
```javascript
  userSchema.methods.isPasswordMatched = async function(newPwd){
    return await bcrypt.compare(newPwd, this.password)
  }
```
âœ¨ è¿™é‡Œåœ¨ä½¿ç”¨å¯¹æ¯”çš„åŒæ—¶ï¼Œå°†è¿™ä¸ªå¯¹æ¯”æ–¹æ³•æ·»åŠ åœ¨`userSchema.methods`å¯¹è±¡ä¸Šï¼Œä½¿å¾—æ‰€æœ‰çš„`model`å®žä¾‹æ‹¥æœ‰`isPasswordMatched`æ–¹æ³•ï¼Œç”¨äºŽ`userModel`çš„å¯†ç åŒ¹é…å¯¹æ¯”æ“ä½œï¼
![ä½¿ç”¨åŠ å¯†å‰çš„å¯†ç è¿›è¡ŒéªŒè¯ç™»å½•](./assets/ä½¿ç”¨åŠ å¯†å‰çš„å¯†ç è¿›è¡ŒéªŒè¯ç™»å½•.png)

ðŸ‘‰ è¿™é‡Œæˆ‘ä»¬å½“æˆ‘ä»¬éœ€è¦åšä¸€äº›ä»Žæ•°æ®åº“ä¸­æŸ¥å‡ºæ¥çš„æ–‡æ¡£å¯¹è±¡è¦è¿›è¡Œç›¸å…³çš„æ“ä½œçš„æ—¶å€™ï¼Œå¯ä»¥é‡‡ç”¨å¾€`schema.methods`ä¸­æ·»åŠ å®žä¾‹æ–¹æ³•çš„æ–¹å¼ï¼Œè¿™æ ·å­æ‰€æœ‰çš„å®žä¾‹åˆ™æ‹¥æœ‰å…¬å…±çš„apiæ–¹æ³•ï¼Œä½†æ˜¯ï¼Œè¿™é‡Œçš„æ–¹æ³•åº”è¯¥æ˜¯ä¸ŽdbæŸ¥è¯¢æ— å…³çš„ï¼ï¼ï¼
##### æ–°å¢žç”¨æˆ·æŽˆæƒä¸­é—´ä»¶(jsonwebtoken)
> ä¸€èˆ¬çš„ï¼Œé’ˆå¯¹ä¸åŒçš„ç”¨æˆ·æƒé™ï¼Œå¯ä»¥è®¾ç½®å…¶ä¸åŒçš„è®¿é—®æƒé™ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨å®šä¹‰ä¸€ä¸ª`auth-middle-ware`ä¸­é—´ä»¶ï¼Œæœ¬æ¬¡é‰´æƒå€ŸåŠ©äºŽ`Bearer token(æŒæœ‰è€…ä»¤ç‰Œ)`
> `Bearer token` çš„å·¥ä½œåŽŸç†æ˜¯ï¼Œå½“ç”¨æˆ·é€šè¿‡èº«ä»½éªŒè¯æœåŠ¡å™¨èŽ·å¾—è®¿é—®ä»¤ç‰Œï¼ˆaccess tokenï¼‰åŽï¼Œè¯¥ä»¤ç‰Œå°†è¢«åŒ…å«åœ¨æ¯ä¸ªè¯·æ±‚çš„å¤´éƒ¨ï¼ˆé€šå¸¸æ˜¯ Authorization å¤´ï¼‰ä¸­ã€‚è¿™ä¸ªä»¤ç‰Œçš„åç§°æ˜¯ "Bearer"ï¼Œå› æ­¤å®ƒè¢«ç§°ä¸º Bearer tokenã€‚
> é€šè¿‡åœ¨`req.headers.authorization`è¯·æ±‚å¤´ä¸­æžå¯¹åº”çš„tokenä¿¡æ¯ï¼Œå¹¶åšä¸€ä¸ªç®€å•çš„è§£æžå¹¶éªŒè¯å…¶æœ‰æ•ˆæ€§ï¼š
```javascript
  let token = req?.headers?.authorization;
  console.info(token)
  token = token.split(' ')[1];
  const decode = jwt.verify(token, process.env.JWT_SECRET);
```
âœ¨ è¿™é‡Œä½¿ç”¨`jwt.verify()`æ–¹æ³•ï¼Œä»Ž`headers.authorization`ä¸­çš„tokenï¼Œä½¿ç”¨åŠ å¯†å‰çš„å¯†é’¥è¦è¿›è¡Œæœ‰æ•ˆæ€§çš„éªŒè¯ï¼Œè€Œè¿™é‡Œçš„tokenåˆ™æ˜¯åœ¨ç”¨æˆ·ç™»å½•æˆåŠŸåŽå­˜å‚¨äºŽæ•°æ®åº“ä¸­å¹¶è¿”å›žï¼Œç”±å®¢æˆ·ç«¯æ¥å¯¹è¿™ä¸ªtokenè¿›è¡Œç®¡ç†ç»´æŠ¤ï¼Œå…³äºŽè¿™ä¸ª`jsonwebtoken`çš„ç›¸å…³ä»‹ç»ï¼Œå¯ä»¥æŸ¥çœ‹[å…³äºŽjwkçš„æè¿°](https://www.91temaichang.com/2023/07/27/koa-middleware-jwt/index.html#post-info)äº†è§£ç›¸å…³çš„è¯¦æƒ…ã€‚
ðŸ‘‰ è¯´ç™½äº†ï¼Œå°±æ˜¯å°†ä¸€å¯¹è±¡ä½¿ç”¨å¯†é’¥åŠ å¯†å­˜å‚¨ï¼Œå¹¶å…·å¤‡ä¸€å®šçš„æœ‰æ•ˆæœŸï¼Œç„¶åŽè¯»å–çš„æ—¶å€™ï¼Œæ‹¿åˆ°å¯†æ–‡è¿›è¡Œå¯¹æ¯”æ ¡éªŒï¼Œæ£€æµ‹å…¶çœŸä¼ªä¸Žæ—¶é—´æœ‰æ•ˆæ€§ï¼Œé€šè¿‡åŽï¼Œå°†è§£å¯†å‡ºåŽŸæ¥çš„æ•°æ®ï¼Œç„¶åŽè¿›è¡Œä¸‹ä¸€æ­¥æ“ä½œï¼ï¼ï¼

ðŸ‘‰ æ ¡éªŒé€šè¿‡ä¹‹åŽï¼Œä»Ždbä¸­æŸ¥è¯¢åˆ°å¯¹åº”çš„ç”¨æˆ·ä¿¡æ¯ï¼Œé€šè¿‡å…¶å±žæ€§`role`åˆ¤æ–­æ˜¯å¦æ‹¥æœ‰ç›¸åº”çš„æƒé™(è¿™é‡Œæå‰åœ¨`userSchema`ä¸­å°†`role`å±žæ€§ç»™åˆ›å»ºå‡ºæ¥ï¼Œä¸”é…ç½®ä»…æŽ¥å—æžšä¸¾ç±»åž‹çš„)ï¼Œè¿™é‡Œä¸€å¼€å§‹æ˜¯å°†ç›¸å…³é‰´æƒä»£ç ç»´æŠ¤åœ¨å„ä¸ªä¸šåŠ¡å¤„ç†ä¸­çš„ï¼Œä½†è€ƒè™‘åˆ°åŽç»­å…¶ä»–åœºæ™¯ä¹Ÿéœ€è¦ä½¿ç”¨åˆ°è¿™ä¸ªé‰´æƒæœºåˆ¶ï¼Œå› æ­¤ï¼Œè¿™è¾¹ç»Ÿä¸€å°†é‰´æƒçš„åŠ¨ä½œæŒªåˆ°è¿™ä¸ª`auth-middle-ware.js`ä¸­é—´ä»¶ä¸­ï¼Œåªæœ‰éªŒè¯é€šè¿‡äº†ï¼Œæ‰èƒ½å¤Ÿç»§ç»­å¾€ä¸‹æ‰§è¡Œï¼ï¼ï¼
```javascript
  // è¿™é‡Œçœç•¥ç›¸å…³ä¸­é—´ä»¶ä»£ç 
  if(findUser.account){
    // å°†å·²ç»éªŒè¯é€šè¿‡çš„è´¦å·ä¿¡æ¯è¿½åŠ åˆ°req.userä¸­ï¼Œå¹¶ä¼ é€’ç»™ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
    req.user = findUser
    // ç›´æŽ¥åœ¨ä¸­é—´ä»¶è¿™é‡Œåšä¸€ä¸ªæ‹¦æˆª
    if('user' === findUser.role){
      res.failed(403, '', 'å½“å‰ç”¨æˆ·æ— æƒé™')
    }else{
      next();
    }
  }else{
    res.failed(-1, null, 'ç™»å½•è¶…æ—¶ï¼')
  }
```

##### æ–°å¢žåˆ·æ–°tokençš„æŽ¥å£APIæœºåˆ¶ï¼Œå¹¶é‡‡ç”¨accessToken+refreshTokenå¹¶è¡Œçš„æœºåˆ¶æ¥ä¿è¯ç³»ç»Ÿä¸­tokençš„æœ‰æ•ˆæ€§
> å½“æ‹¥æœ‰äº†è¿™ä¸ªtokençš„æ—¶å€™ï¼Œç”±äºŽ`jsonwebtoken`çš„æœºåˆ¶ï¼Œæˆ‘ä»¬æ‰€ç”Ÿæˆçš„tokenæœ‰ä¸€å®šçš„æ—¶æ•ˆæ€§ï¼Œåœ¨å®žé™…çš„é¡¹ç›®å¼€å‘ä¸­ï¼Œåº”è¯¥è¦ç¡®ä¿ç”Ÿæˆçš„tokenåªè¦ç»§ç»­ä½¿ç”¨çš„è¯ï¼Œæ¯æ¬¡ä½¿ç”¨éƒ½å°†
> è‡ªåŠ¨å»¶é•¿tokençš„æ—¶æ•ˆæ€§ï¼Œä½†æ˜¯`jsonwebtoken`æ˜¯é€šè¿‡æ¯æ¬¡éƒ½ç”Ÿæˆæ–°çš„tokenæ¥ç¡®ä¿å»¶é•¿æ—¶é•¿çš„ï¼Œç„¶åŽå®¢æˆ·ç«¯çš„tokenä¸€èˆ¬æ˜¯ä¿å­˜åœ¨æœ¬åœ°çš„ï¼Œé‚£ä¹ˆï¼ŒðŸ¤”å°±éœ€è¦ä¸€ç§æœºåˆ¶ï¼Œæ¥å®žçŽ°è‡ªåŠ¨â€œæ›´æ–°â€
> å®¢æˆ·ç«¯tokençš„æœºåˆ¶ï¼ŒðŸ‘‰è¿™é‡Œçš„â€œæ›´æ–°â€ï¼Œå…¶å®žæ˜¯é‡‡ç”¨äº†åŒtokençš„æ–¹å¼ï¼Œä¸€ä¸ªæ˜¯`accessToken`(æœ‰æ•ˆæ—¶é•¿è¾ƒçŸ­ï¼Œç”¨äºŽé‰´æƒç›®çš„)ï¼Œå¦å¤–ä¸€ä¸ªæ˜¯`refreshToken`(æœ‰æ•ˆæ—¶é•¿è¾ƒé•¿ï¼Œç”¨äºŽåˆ·æ–°tokençš„ç›®çš„)ï¼Œå®Œæ•´çš„åŒtokenæ›´æ–°æœºåˆ¶å¦‚ä¸‹æ‰€ç¤ºï¼š
![åŒtokenéªŒè¯æµç¨‹](./assets/åŒtokenéªŒè¯æµç¨‹.png)

âœ¨ åŒæ—¶å®¢æˆ·ç«¯ä¹Ÿè¦é…åˆä¸€ä¸ªæµç¨‹ï¼Œå°±æ˜¯å…³äºŽ**accessTokenåœ¨æŽ¥è¿‘å¤±æ•ˆçš„æ—¶å€™ï¼Œéœ€è¦è‡ªåŠ¨å‘é€refreshTokenåŠ¨ä½œï¼Œå®Œæˆå®¢æˆ·ç«¯tokençš„æŒç»­æœ‰æ•ˆæ€§**ï¼ï¼

#### äº§å“æ¨¡å—ä¸­é—´ä»¶

#### è®¢å•æ¨¡å—ä¸­é—´ä»¶

### uniqueå±žæ€§èƒ½å¦ç”¨æ¥åšæ ¡éªŒï¼Ÿ
![æ²¡æœ‰ä»»ä½•é™åˆ¶çš„æ•°æ®](./assets/æ²¡æœ‰ä»»ä½•é™åˆ¶çš„æ•°æ®.png)
> åœ¨å®šä¹‰userSchemaçš„æ—¶å€™ï¼Œå‘çŽ°å±žæ€§å¯ä»¥é…ç½®`unique=true`ï¼Œé‚£ä¹ˆè¿™ç§æ–¹å¼æ˜¯å¦å¯ä»¥ç”¨æ¥é…ç½®ä¸èƒ½å¾€dbä¸­æ’å…¥åŒæ ·valueçš„è®°å½•ï¼Ÿ
> ![uniqueçš„çœŸæ­£ç”¨é€”](./assets/uniqueçš„çœŸæ­£ç”¨é€”.png)
> ç­”æ¡ˆæ˜¯å¦å®šçš„ï¼Œå› æ­¤è¿™ä¸ª`unique`åªæ˜¯ç”¨æ¥å‘ŠçŸ¥åˆ›å»ºçš„ç´¢å¼•å€¼æ˜¯å¦è¦å”¯ä¸€ï¼Œä»…æ­¤è€Œå·²ï¼Œè¯¦è§[å®˜ç½‘æè¿°](https://mongoosejs.com/docs/validation.html#the-unique-option-is-not-a-validator)

### é›†æˆè¯·æ±‚æ—¥å¿—è¾“å‡ºä¸­é—´ä»¶
![è¯·æ±‚æ—¥å¿—è¾“å‡ºä¸­é—´ä»¶](./assets/è¯·æ±‚æ—¥å¿—è¾“å‡ºä¸­é—´ä»¶.png)
âœ¨ åœ¨è°ƒè¯•çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡`morgan`ä¸­é—´ä»¶ï¼Œæ¥æŸ¥çœ‹å½“å‰è¯·æ±‚çš„æŽ¥å£éƒ½æœ‰å“ªäº›ï¼Œä»¥åŠè¯·æ±‚è¿™äº›æŽ¥å£çš„åŸºæœ¬ä¿¡æ¯ã€‚

### mongooseè‡ªåŠ¨è¿½åŠ çš„é»˜è®¤å±žæ€§
> å½“æˆ‘ä»¬ä½¿ç”¨`mongoose`çš„`new model().save()`æ–¹æ³•æ¥åˆ›å»ºä¸€æ¡è®°å½•çš„æ—¶å€™ï¼Œåœ¨`model`æ‰€æ†ç»‘çš„`schema`ä¸­çš„å±žæ€§ï¼Œå°†ä¼šè‡ªåŠ¨åˆ›å»ºå‡ºæ¥ï¼Œå¹¶èµ‹äºˆé»˜è®¤çš„å±žæ€§å€¼ï¼Œæ–¹ä¾¿åŽç»­çš„æ’å…¥æ ¡éªŒéªŒè¯é—®é¢˜ï¼ï¼

### å…³äºŽè¯·æ±‚å‚æ•°çš„æ ¡éªŒ
> åœ¨è¿›è¡Œå•†å“çš„å‘å¸ƒ/ç¼–è¾‘æŽ¥å£é€»è¾‘ç¼–å†™çš„æ—¶å€™ï¼Œå‘çŽ°å¦‚æžœæ‰‹åŠ¨ä¸€ä¸ªä¸ªæ¥ç¼–å†™è¿™ä¸ªå‚æ•°çš„æ ¡éªŒçš„è¯ï¼Œå°†ä¼šå¯¼è‡´æŽ¥å£æ–¹æ³•é€»è¾‘æ¯”è¾ƒé•¿ï¼Œè€Œä¸”å¥½åƒä¹Ÿæ²¡åŠžæ³•å¤ç”¨ï¼Œå› æ­¤ï¼Œè¿™è¾¹åœ¨ä½¿ç”¨åŽŸæœ¬`mongoose`
> æ‰€æä¾›çš„æ ¡éªŒæœåŠ¡çš„åŸºç¡€ä¸Šï¼Œå¦å¤–æ–°å¢žäº†`express-validator`è¿™ä¸ªåŸºäºŽè·¯ç”±å±‚é¢çš„æ•°æ®æ ¡éªŒä¸­é—´ä»¶ï¼Œé€šè¿‡å¯¹è¯·æ±‚ä¸­çš„`body`ã€`query`ã€`header`ç­‰ä¸åŒä½ç½®çš„æ•°æ®è¿›è¡ŒèŽ·å–ä¸Žæ ¡éªŒï¼Œ
> åœ¨è¿›å…¥åˆ°`model`å±‚ä¹‹å‰è¿›è¡Œæ•°æ®çš„æ ¡éªŒï¼Œå‡å°‘æ•°æ®åº“çš„è‡ªæˆ‘æ ¡éªŒåŽ‹åŠ›ã€‚
```javascript
  const express = require('express');
  const app = new express();
  // åœ¨è¿˜æœªä½¿ç”¨æ ¡éªŒä¸­é—´ä»¶ä¹‹å‰çš„å¤„ç†æ–¹å¼
  app.get('/hello', (req, res) => {
    let { field1 } = req.body;
    if(field1){
      throw new Error('å¿…é¡»ä¼ é€’æ•°å€¼ç±»åž‹çš„field1')
    }
    res.send(`Hello, ${req.body.person}!`);
  })
  // åœ¨ä½¿ç”¨äº†`express-validate`ä¹‹åŽ
  const { body, validationResult } = require('express-validator');
  app.get('/hello', body('field1').notEmpty(), (req, res) => {
    const result = validationResult(req);
    if (result.isEmpty()) {
      return res.send(`Hello, ${req.body.person}!`);
    }
    res.send({ errors: result.array() });
  })
```
:stars: å½“éœ€è¦æ ¡éªŒçš„å±žæ€§å¹¶æ²¡æœ‰é‚£ä¹ˆå¤šä¸”å¤æ‚çš„æ—¶å€™ï¼Œå•çº¯çš„ç›´æŽ¥å°†å…¶é€»è¾‘ç»´æŠ¤åˆ°æ–¹æ³•ä¸­å¹¶æ²¡æœ‰ä»€ä¹ˆï¼Œä½†æ˜¯ä¸€æ—¦éœ€è¦æ ¡éªŒçš„å­—æ®µå±žæ€§è¾ƒå¤šï¼Œè€Œä¸”æ ¡éªŒè§„åˆ™è¾ƒä¸ºå¤æ‚çš„æ—¶å€™ï¼Œå°±éœ€è¦åºžå¤§çš„æ ¡éªŒè§„åˆ™ï¼Œè€Œä¸”ä¹Ÿæ— æ³•å¤ç”¨å·²ç»ç»´æŠ¤å¥½çš„æ ¡éªŒè§„åˆ™ï¼Œå› æ­¤ï¼Œé’ˆå¯¹è¿™ç§åœºæ™¯ï¼Œé‡‡ç”¨**express-validator**æ¥å¯¹æ•°æ®è¿›è¡Œä¸­é—´ä»¶å±‚é¢çš„æ ¡éªŒï¼Œé€šè¿‡åœ¨ä¸­é—´ä»¶å±‚é¢ï¼Œå¯¹å®¢æˆ·ç«¯è¯·æ±‚è¿›è¡Œæ•°æ®æ‹¦æˆªå¤„ç†ï¼Œå¹¶åœ¨æ ¡éªŒé€šè¿‡åŽï¼Œè¿›å…¥åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶ï¼Œæå‰å°†é”™è¯¯è¿›è¡Œæ‹¦æˆªï¼Œå‡å°‘æ•°æ®åº“ä»£ç é€»è¾‘çš„æ‰§è¡ŒåŽ‹åŠ›ï¼ï¼

:trollface: å®žé™…ä¸Šåœ¨ä½¿ç”¨çš„æ—¶å€™ï¼Œä¸ºäº†æ›´å¥½çš„ç»´æŠ¤é¡¹ç›®ä»£ç ï¼Œè¿™è¾¹é‡‡ç”¨å°†æ ¡éªŒä¸Žé€»è¾‘å®Œå…¨çš„åˆ†å¼€ï¼Œæ ¡éªŒä¸­é—´ä»¶å•ç‹¬å¤„ç†æ ¡éªŒåŠ¨ä½œä»¥åŠæ ¡éªŒç»“æžœåˆ¤æ–­ï¼Œè€Œé€»è¾‘ä¸­é—´ä»¶åˆ™ä¿ç•™åŽŸæœ¬çš„é€»è¾‘ä»£ç ä¸å˜åŒ–ï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š

```javascript
  // ...è¿™é‡Œçœç•¥ä¸€ç³»åˆ—ç›¸å…³çš„ä»£ç 
  // å‘å¸ƒä¸€ä¸ªå•†å“ï¼Œè·¯ç”±è·¯å¾„ä»¥åŠè¯·æ±‚æ–¹å¼ä¿ç•™åŽŸæœ¬çš„å®šä¹‰ä¸å˜
  productRouter.put('/publish', productCtrl.createProduct);
  // åŒæ ·æ­£å¸¸å¼•å…¥express-async-handler
  const asyncHandler = require('express-async-handler');
  const { body, validationResult } = require('express-validator');
  const validateProduct = [
    body('productName').notEmpty().trim().isLength({ max: 60 }),
    body('cates').notEmpty().isArray(),
    // è¿™é‡Œæ ¹æ®å®žé™…æƒ…å†µè¿›è¡Œå„ä¸ªå­—æ®µçš„ä¸€ç³»åˆ—åˆ¤æ–­
    // è¿™é‡Œæ˜¯ç»“æžœæ ¡éªŒåˆ¤æ–­ä¸­é—´ä»¶ï¼Œè¿™é‡Œå¯æ ¹æ®å®žé™…æƒ…å†µåˆ¤æ–­æ˜¯å¦éœ€è¦ä½¿ç”¨å¼‚æ­¥æ“ä½œ
    asyncHandler(async (req, res, next) => {
      const errorResult = validationResult(req);
      if(!errorResult){
        // å¦‚æžœæ ¡éªŒé€šè¿‡ï¼Œåˆ™è¿›å…¥åˆ°ä¸‹ä¸€ä¸ªä¸­é—´ä»¶
        next()
      }
      // æ ¡éªŒå¤±è´¥ï¼Œåˆ™æç¤ºå¤±è´¥åŽŸå› ï¼Œè¿™é‡Œèµ°ç»Ÿä¸€çš„è‡ªå®šä¹‰æ ¼å¼è¾“å‡ºåŠ¨ä½œ
      res.failed(-1, { errors: result.array() })
    })
  ]
  export createProduct = [validateProduct, asyncHandler(async (req, res) => {
    // è¿™é‡Œä¾æ—§æ˜¯æ­£å¸¸çš„é€»è¾‘å¤„ç†åŠ¨ä½œ
  })]
```
:star: é€šè¿‡ä¸Šè¿°çš„æ–¹å¼ï¼Œå°†æ ¡éªŒåŠ¨ä½œä¸ŽåŽŸæœ¬çš„é€»è¾‘å®Œå…¨çš„åˆ†ç¦»å¼€æ¥ï¼Œæœ€ç»ˆå¯¹å¤–æä¾›ä¸€æ•°ç»„æ–¹å¼çš„ä¸­é—´ä»¶æˆå‘˜å³å¯ï¼ï¼
![express-validatoråŸºæœ¬ä½¿ç”¨ç»“æžœ](./assets/express-validatoråŸºæœ¬ä½¿ç”¨ç»“æžœ.png)
:confused: å¦‚æžœæˆ‘è¿™ä¸ªæ ¡éªŒåŠ¨ä½œæ˜¯å¼‚æ­¥çš„è¯ï¼Œæ¯”å¦‚éœ€è¦ä»Ždbä¸­æŸ¥è¯¢æ˜¯å¦ä¸ºæ­£ç¡®çš„å­—æ®µæ—¶ï¼Œéœ€è¦ä½¿ç”¨åˆ°å…¶è‡ªå®šä¹‰æ ¡éªŒï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºï¼š
```javascript
  const validateProduct = [
    body('cates').custom(async value => {
      // è¿™é‡Œçš„valueå­—æ®µä¸ºå®žé™…çš„å­—æ®µå€¼
      const findCates = await productModel.findOne()
      if(!findCates){
        throw new Error('è¯·å¡«å†™æ­£ç¡®çš„åˆ†ç±»id')
      }
    })
  ]
```
![express-validatorè‡ªå®šä¹‰æ ¡éªŒç»“æžœ](./assets/express-validatorè‡ªå®šä¹‰æ ¡éªŒç»“æžœ.png)

:point_right: å¦‚æžœæ ¡éªŒåŠ¨ä½œéƒ½æ˜¯ä¸€è‡´çš„è¯ï¼Œè¿˜å¯ä»¥ç›´æŽ¥å°†å†…ç½®çš„æ ¡éªŒç»“æžœåˆ¤æ–­ä¸­é—´ä»¶ç»™æŠ½ç¦»å‡ºæ¥ï¼Œå•ç‹¬è¿›è¡Œç»Ÿä¸€çš„ç»´æŠ¤ï¼ï¼

:confused: ä¸Šè¿°çš„è¾“å‡ºç»“æžœä¸­ï¼Œéƒ½æ˜¯è‹±æ–‡çš„è¾“å‡ºï¼Œæ˜¯å¦å¯ä»¥å®žçŽ°é’ˆå¯¹å­—æ®µçº§åˆ«è¿›è¡Œè‡ªå®šä¹‰messageçš„é…ç½®è¾“å‡ºå‘¢ï¼Ÿ
```javascript
  //... è¿™é‡Œéšè—ä¸€ç³»åˆ—ä»£ç 
  body('productName', 'è¯·ç»´æŠ¤å•†å“åç§°')
```
![express-validatorè‡ªå®šä¹‰å­—æ®µæ ¡éªŒæç¤ºè¯­](./express-validatorè‡ªå®šä¹‰å­—æ®µæ ¡éªŒæç¤ºè¯­.png)

### è‡ªå®šä¹‰mongooseå…¨å±€æ’ä»¶
> åœ¨å®žé™…çš„é¡¹ç›®è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä»¬ä¸èƒ½å¤Ÿå®Œå…¨ç›¸ä¿¡å®¢æˆ·ç«¯æäº¤è¿‡æ¥çš„æ•°æ®ï¼Œæ¯”å¦‚æœ‰äº›å­—æ®µå¯èƒ½æ²¡æœ‰åŽ»é™¤å­—æ®µä¸¤ç«¯çš„ç©ºæ ¼ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œå¯ä»¥ä½¿ç”¨`mongoose`çš„æ³¨å†Œå…¨å±€æ’ä»¶çš„æ–¹å¼ï¼Œå¯¹é¡¹ç›®ä¸­çš„æ‰€æœ‰çš„`schema`ä¸­çš„å­—ç¬¦ä¸²å­—æ®µåœ¨ä¿å­˜çš„æ—¶å€™ï¼Œ
> æä¾›ä¸€ä¸ªè‡ªæˆ‘è½¬æ¢çš„åŠŸèƒ½ï¼Œæ¥å®žçŽ°è¿™ä¸ªç›®çš„ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š 
```javascript
  // åœ¨æ•°æ®åº“è¿žæŽ¥ä¹‹å‰ï¼Œè¿›è¡Œå…¨å±€æ’ä»¶çš„æ³¨å†Œ
  const globalPlugin = (schema, options) => {
    // è¿™é‡Œçš„optionsåˆ™ä»£è¡¨æ’ä»¶çš„å‚æ•°ï¼Œå¯å®žçŽ°å‚æ•°åŒ–æŽ‰ç”¨çš„ç›®çš„
    // schemaä¸ºmongooseä¸­çš„æ‰€æœ‰çš„schemaå¯¹è±¡ï¼Œé€šè¿‡å¯¹è¿™ä¸ªschemaä¸­çš„å±žæ€§è¿›è¡ŒéåŽ†å¤„ç†
    schema.pre('save', function(next) {
      Object.keys(schema.paths).forEach(field => {
        if(this[field]){
          // æ‰€æœ‰æ’å…¥åˆ°dbä¸­çš„å­—æ®µï¼Œéƒ½å¿…é¡»è¿›è¡Œtrimæ“ä½œï¼Œé¿å…å­˜å‚¨äº†å·¦å³ä¸ºç©ºçš„å­—ç¬¦ä¸²
          if(schema.pathType(field) === 'String'){
            // å¦‚æžœæ–‡æ¡£ä¸­çš„fieldå±žæ€§å­˜åœ¨ä¸”ä¸ºå­—ç¬¦ä¸²ç±»åž‹çš„
            this[field] = this[field].trim();// ç»Ÿä¸€åŽ»é™¤å­—ç¬¦ä¸²ä¸¤ç«¯çš„ç©ºç™½å­—ç¬¦ä¸²
          }
        }
        next();
      })
    })
  }
  // åœ¨connectåˆ°æ•°æ®åº“ä¹‹å‰
  mongoose.plugin(globalPlugin);
```

## é¡¹ç›®è¿‡ç¨‹ä¸­çš„å‘
> æœ¬ç« èŠ‚ä¸»è¦åœ¨å®žé™…çš„é¡¹ç›®ç¼–ç è¿‡ç¨‹ä¸­ï¼Œæ‰€é‡åˆ°çš„å‘ï¼Œä»¥å…åŽç»­å†è¸©ï¼ï¼ï¼

### è¿žæŽ¥mongodbå®˜ç½‘æä¾›çš„å…è´¹æ•°æ®åº“ï¼Œä¸€ç›´è¿žæŽ¥ä¸ä¸Šï¼Œå¼€äº†ä»£ç†ä¹Ÿæ˜¯å¦‚æ­¤
> å¯é€šè¿‡é˜…è¯»å®˜æ–¹çš„[ç½‘ç»œè¿žæŽ¥](https://www.mongodb.com/docs/atlas/troubleshoot-connection/)ï¼Œé€šè¿‡è®¾ç½®googleçš„å…¬å…±DNSï¼Œå®žçŽ°è¿œç¨‹æ­£å¸¸è®¿é—®æ•°æ®åº“çš„ç›®çš„ï¼
![é…ç½®å…è®¸ç›¸å…³çš„ipåœ°å€è®¿é—®](./assets/é…ç½®å…è®¸ç›¸å…³çš„ipåœ°å€è®¿é—®.png)
![é…ç½®DNS](./assets/é…ç½®DNS.png)

### å…³äºŽä½¿ç”¨mongodbä¸Žmongooseï¼Œéœ€è¦å°†è¦è¿žæŽ¥çš„æ•°æ®åº“ä¹Ÿç»´æŠ¤åˆ°urlä¸­
> ðŸ˜¡ åœ¨æ‹¿`mongodb`ä»¥åŠ`mongoose`ä¸¤ä¸ªå®˜æ–¹æ–‡æ¡£å¯¹æ¯”ç¼–ç çš„æ—¶å€™ï¼Œå¿˜è®°å°†æ•°æ®åº“ä¹Ÿç»´æŠ¤åˆ°`driver`çš„é“¾æŽ¥ä¸­ï¼Œå¯¼è‡´æ•°æ®æˆåŠŸæ’å…¥äº†ï¼Œä½†æ˜¯æ•°æ®åœ¨æ•°æ®åº“ä¸­å´æ²¡æœ‰æŸ¥è¯¢åˆ°ï¼ï¼ï¼
![mongooseè¿žæŽ¥éœ€è¦å£°æ˜Žè¦è¿žæŽ¥çš„æ•°æ®åº“](./assets/mongooseè¿žæŽ¥éœ€è¦å£°æ˜Žè¦è¿žæŽ¥çš„æ•°æ®åº“.png)

### å…³äºŽmongooseä¸­çš„findOne()åŠ ä¸åŠ exec()æ–¹æ³•
> `mongoose`ä¸­çš„`query.exec()`é€šå¸¸ç”¨äºŽæ‰§è¡Œä¸€ä¸ªæ“ä½œå¹¶è¿”å›žä¸€ä¸ªPromiseå¯¹è±¡ï¼Œå¦‚æžœæ²¡æœ‰æ·»åŠ è¿™ä¸ª`exec()`æ–¹æ³•(æ¯”å¦‚ä½¿ç”¨Model.findOne()æ–¹æ³•)ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™ï¼Œ
> `Model.findOne()`æ–¹æ³•å°†è¿”å›žä¸€ä¸ªéšè—çš„Promiseï¼Œè¿™ä¸ªæ—¶å€™ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡å¯¹ç»“æžœç›´æŽ¥é€šè¿‡å±žæ€§è®¿é—®ç¬¦å³å¯ç›´æŽ¥è®¿é—®åˆ°ç›®æ ‡ç»“æžœ
```javascript
  // æ–¹å¼ä¸€ï¼š
  const findUser = await userModel.findOne({_id: 'xxx_id'}).exec()
  // æ–¹å¼äºŒï¼š
  const findUser = await userModel.findOne({_id: 'xxx_id'})
  // ä»¥ä¸Šä¸¤ç§æ–¹å¼ï¼Œéƒ½å¯ä»¥é‡‡ç”¨ ðŸ‘‡ çš„æ–¹å¼æ¥è¯»å–ä¿¡æ¯
  console.info(findUser.account)
```

### å…³äºŽmongooseçš„Model.updateOne()æ–¹æ³•ä¸èµ·ä½œç”¨çš„åŽŸå› 
> åœ¨é¡¹ç›®codingçš„è¿‡ç¨‹ä¸­ï¼Œå‘çŽ°`Model.updateOne()`å§‹ç»ˆè¿”å›žçš„æ˜¯`{acknowledged: false}`ï¼Œæ£€æŸ¥äº†å…¶ä»–çš„è¿žæŽ¥ç›¸å…³çš„ä»£ç ï¼Œéƒ½æ­£å¸¸ï¼Œæœ€åŽå‘çŽ°ï¼Œè¿™ä¸ª **mongooseä¸å…è®¸schemaä¿®æ”¹schemaä¹‹å¤–çš„å­—æ®µ(mongooseé»˜è®¤ä¸ºä¸¥æ ¼æ¨¡å¼)**ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œè™½ç„¶`mongodb`å¹¶æ²¡æœ‰ä¸¥æ ¼é™åˆ¶è¯´è¿½åŠ å­—æ®µå¿…é¡»åƒ`mysql`é‚£æ ·å­æ¥ç»´æŠ¤ï¼Œä½†æ˜¯ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨`mongoose`çš„æ—¶å€™ï¼Œåˆ™å¿…é¡»æå‰å°†ç›¸å…³æ¶‰åŠåˆ°çš„å­—æ®µç»™ç»´æŠ¤èµ·æ¥ï¼Œä»¥å…åœ¨æ›´æ–°çš„æ—¶å€™ï¼Œç›´æŽ¥æ‰§è¡Œå¼‚å¸¸ï¼ï¼ï¼

### å…³äºŽjwtå¼‚å¸¸ä½¿ç”¨çš„æ–¹å¼
> `jwt.verify()`æ–¹æ³•åœ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œå¦‚æžœè¿™ä¸ªæ—¶å€™å› ä¸ºè¿‡æœŸåŽŸå› å¯¼è‡´çš„å¼‚å¸¸ï¼Œå°†ç›´æŽ¥é€šè¿‡`throw error`çš„æ–¹å¼æ¥å°†å¼‚å¸¸æŠ›å‡ºï¼Œå› æ­¤ï¼Œæˆ‘ä»¬åœ¨ä½¿ç”¨è¿™ä¸ªæ–¹æ³•è¿›è¡Œtokenæœ‰æ•ˆæ€§æ ¡éªŒçš„æ—¶å€™ï¼Œå°±éœ€è¦ä½¿ç”¨`try...catch`çš„æ–¹å¼ï¼Œæ¥å°†å¯èƒ½çš„å¼‚å¸¸è¿›è¡Œè‡ªè¡Œæ•èŽ·ï¼Œå¹¶åœ¨å¼‚å¸¸å‘ç”Ÿçš„æ—¶å€™ï¼Œå°†å¼‚å¸¸ç»™ä¸¢å‡ºæ¥ï¼

### å…³äºŽmongooseä¸­ObjectIdæ•°ç»„ç±»åž‹çš„å®šä¹‰
> åœ¨ä½¿ç”¨`mongoose`æ¥å®šä¹‰`schema`ä¸­çš„å±žæ€§ç±»åž‹çš„æ—¶å€™ï¼Œå‡å¦‚éœ€è¦å°†æŸä¸ªå±žæ€§å®šä¹‰ä¸º`*ObjectIdæ•°ç»„å¤–é”®*`çš„è¯ï¼Œåˆ™å¯ä»¥æŒ‰ç…§ :point_down: çš„æ–¹å¼æ¥å£°æ˜Žï¼š
```js
// å•çº¯çš„å®šä¹‰ä¸ºObjectIdæ•°ç»„
  const schema = new mongoose.Schema({
    products: {
      type: [mongoose.SchemaTypes.ObjectId]
    }
  })
// å®šä¹‰ä¸ºå¯¹è±¡ï¼Œå¹¶å°†å…¶è®¾ç½®ä¸ºåŽç»­å¯é€šè¿‡populateå…³è”æŸ¥è¯¢ä¸ºå¯¹åº”çš„å•†å“å¯¹è±¡
  const schema = new mongoose.Schema({
    products: {
      type: [{
        type: mongoose.SchemaTypes.ObjectId,
        ref: 'products'
      }]
    }
  })
```

### å…³äºŽmongooseä¸­åµŒå¥—æŸ¥è¯¢çš„ä½¿ç”¨
> åœ¨ä½¿ç”¨`mongoose`æ¥å¯¹æ•°æ®è¿›è¡ŒæŸ¥è¯¢æ—¶å€™ï¼Œå‡å¦‚éœ€è¦å°†ä¸€ä¸ªåˆ—è¡¨è½¬ä¸ºæ ‘çŠ¶ï¼Œæ¯”å¦‚è¿™ä¸ªåˆ†ç±»åˆ—è¡¨æ ‘çŠ¶ç»“æž„è¾“å‡ºï¼Œéœ€è¦åº”ç”¨å±‚è‡ªå®šä¹‰é€»è¾‘ä»£ç ï¼Œ
> é€šè¿‡è¿‡æ»¤ç­›é€‰åŠ¨ä½œï¼ŒæŸ¥è¯¢å‡ºå¯¹åº”çš„æ•°æ®ï¼Œä½†æ˜¯ç”±äºŽåœ¨æŸ¥è¯¢çš„è¿‡ç¨‹ä¸­åˆè¿›è¡Œäº†åµŒå¥—æŸ¥è¯¢æ“ä½œï¼Œè¿™è¾¹é‡‡ç”¨äº†`Array.map()`æ–¹æ³•å¯¹æŸ¥è¯¢ç»“æžœè¿›è¡Œ
> è½¬æ¢è¾“å‡ºï¼Œé’ˆå¯¹æ¯ä¸ªå…ƒç´ åˆå†æ¬¡è¿›è¡Œçš„æŸ¥è¯¢ç­›é€‰åŠ¨ä½œï¼Œ:point_right: å› æ­¤ï¼Œéœ€è¦å°†æ¯ä¸€æ¬¡çš„æŸ¥è¯¢ç­›é€‰åŠ¨ä½œè½¬æ¢ä¸ºä¸€ä¸ªpromiseï¼Œ
> ç„¶åŽå€Ÿç”±`Promise.all()`æ–¹æ³•ï¼Œæ¥å°†æ‰€æœ‰çš„æŸ¥è¯¢ç»“æžœç»™thenå‡ºæ¥
```javascript
  const childCateListPromise = cateList2.map(async (cate2) => {
    const cateList3 = await cateModel.find({parentId: cate2._id});
    return {
      ...cate2.toObject(),
      children: cateList3
    }
  });
  const children = await Promise.all(childCateListPromise);
```
:stars: è¿™é‡Œé€šè¿‡å°†cateList2è½¬æ¢ä¸ºpromiseæ•°ç»„ï¼Œç„¶åŽæœ€åŽå†ä¸€å£æ°”æ‰§è¡Œå…¨éƒ¨çš„promiseï¼Œå®žçŽ°å°†ç»“æžœè¾“å‡ºè‡³childrenå±žæ€§ä¸­ï¼ï¼ï¼

### å…³äºŽmodel.findByIdAndUpdate()æ–¹æ³•æ²¡æœ‰è§¦å‘å±žæ€§çš„æ ¡éªŒè§„åˆ™
> å½“æˆ‘ä»¬é€šè¿‡`mongoose`çš„`model.findByIdAndUpdate()`æ–¹æ³•æ¥æ›´æ–°ä¸€ä¸ªå±žæ€§çš„æ—¶å€™ï¼Œå¦‚æžœæ²¡æœ‰åœ¨å…¶ç¬¬ä¸‰ä¸ªå‚æ•°ä¸­å£°æ˜Ž`runValidators:true`çš„æ—¶å€™ï¼Œ
> è™½ç„¶æˆ‘ä»¬å·²ç»ç»™å±žæ€§å®šä¹‰çš„æ—¶å€™ï¼Œå°†å…¶`validate`ä¹Ÿè¿›è¡Œäº†ç›¸åº”çš„é…ç½®ï¼Œä½†æ˜¯åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œ`mongoose`åœ¨æ›´æ–°æ—¶ï¼Œå¯èƒ½å…è®¸ç»•è¿‡éªŒè¯ï¼Œè¿™æ˜¯å› ä¸º`mongoose`é»˜è®¤æƒ…å†µä¸‹åªä¼šéªŒè¯ä¼ é€’ç»™
> `save()`æ–¹æ³•çš„æ•°æ®ï¼Œä¸ºäº†ç¡®ä¿å±žæ€§çš„è‡ªæˆ‘æ ¡éªŒè§„åˆ™èƒ½å¤Ÿè¢«è‡ªåŠ¨çš„è§¦å‘ï¼Œå› æ­¤éœ€è¦å¾€ç›¸åº”çš„æ–¹æ³•(model.findByIdAndUpdate)ä¸­ä¼ é€’`runValidators: true`çš„å±žæ€§ï¼Œå‘ŠçŸ¥è¯¥API
> å½“æ‰§è¡Œç›¸å…³çš„æ“ä½œçš„æ—¶å€™ï¼Œè‡ªåŠ¨è¿›è¡Œå¯¹åº”çš„æ ¡éªŒæ“ä½œï¼ï¼

## é¡¹ç›®ç”±jså‡çº§è‡³ts
[å‡çº§æ–‡æ¡£](./doc/å‡çº§è‡³ts.md)

## é¡¹ç›®è°ƒè¯•
> ä½œä¸ºåŽç«¯APIæœåŠ¡å¼€å‘ï¼Œä¸€èˆ¬éƒ½éœ€è¦è¿›è¡ŒæŽ¥å£APIçš„è°ƒè¯•ä¸ŽéªŒè¯ï¼Œå› æ­¤ï¼Œè¿™è¾¹é‡‡ç”¨`postman`æ¥è¿›è¡Œè°ƒè¯•ï¼Œé€šè¿‡é…ç½®å…¶ä¸­çš„å…¬å…±é€»è¾‘éƒ¨åˆ†ä»¥åŠå¯¹åº”çš„å‚æ•°èŽ·å–é€»è¾‘ï¼Œä½¿å¾—æ•´ä¸ªé¡¹ç›®èƒ½å¤Ÿå…±ç”¨åŒä¸€ä¸ªæŽ¥å£è°ƒè¯•é€»è¾‘ï¼
> ðŸ‘‰ è¿™ä¸ªæ˜¯æˆ‘çš„teamï¼šhttps://www.postman.com/zglin8902/workspace/kbmjj123

